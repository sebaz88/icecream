<!DOCTYPE html>
<html>
<head>
  <title>Ice Cream Day & 90Â°F Day Tracker</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f8ff;
      color: #333;
      text-align: center;
      padding: 20px;
    }
    h1, h2 {
      color: #0056b3;
    }
    .weather-container, .table-container {
      border: 2px solid #0056b3;
      border-radius: 10px;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0px 4px 6px rgba(0,0,0,0.1);
      display: inline-block;
      margin-bottom: 40px;
    }
    #temperature, #ice-cream-status, #counter-status {
      font-size: 1.2em;
      margin: 10px 0;
    }
    .loading {
      font-size: 1em;
      color: #007f5f;
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }
    table {
      border-collapse: collapse;
      margin: 0 auto;
      width: 100%;
      max-width: 500px;
    }
    th, td {
      border: 1px solid #0056b3;
      padding: 8px 12px;
      text-align: center;
    }
    th {
      background-color: #e6f2ff;
    }
  </style>
</head>
<body onload="getWeather(); countHotDays();">

  <!-- ICE CREAM DAY WIDGET -->
  <h1>Is it Ice Cream Day Today?</h1>
  <div class="weather-container">
    <p id="temperature"></p>
    <p id="ice-cream-status"></p>
    <p id="loading" class="loading" style="display:none;">Fetching weather data...</p>
  </div>

  <!-- 90Â°F DAY COUNTER WIDGET -->
  <h1>90Â°F+ Days in Charlottesville (2025)</h1>
  <div class="weather-container">
    <p id="counter-status">Loadingâ€¦</p>
    <p id="counter-result"></p>
  </div>

  <!-- FULL LIST TABLE -->
  <h2>List of Hot Days (â‰¥ 90Â°F)</h2>
  <div class="table-container">
    <table>
      <thead>
        <tr><th>Date</th><th>Max Temp (Â°F)</th></tr>
      </thead>
      <tbody id="hot-days-body">
        <!-- rows go here -->
      </tbody>
    </table>
  </div>

  <script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // CONFIG
  const apiKey = "853d377f2cb7f62a43fb1bc298efd91b";
  const city   = "Charlottesville";
  const lat    = 38.0293;
  const lon    = -78.4767;

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ICE CREAM DAY CHECK
  async function getWeather(){
    const loadEl = document.getElementById("loading");
    loadEl.style.display = "block";
    try {
      let res = await fetch(
        `https://api.openweathermap.org/data/2.5/weather`
        + `?q=${city}&units=imperial&appid=${apiKey}`
      );
      let data = await res.json();
      let high = data.main.temp_max;
      document.getElementById("temperature").innerText =
        `High today in ${city}: ${high.toFixed(1)} Â°F`;
      document.getElementById("ice-cream-status").innerText =
        high >= 90
          ? "ğŸ¦ Yes â€” time for ice cream!"
          : "ğŸ˜¢ Not quite 90Â°F yet.";
    } catch (err) {
      document.getElementById("temperature").innerText =
        "Error fetching weather.";
      document.getElementById("ice-cream-status").innerText =
        "Check your API key or network.";
    } finally {
      loadEl.style.display = "none";
    }
  }

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // 90Â°F DAY COUNTER + LIST WITH CACHING
  function generateDateRange(startDate, endDate){
    let dates = [];
    let cur = new Date(startDate);
    let end = new Date(endDate);
    while(cur <= end){
      dates.push(new Date(cur));
      cur.setDate(cur.getDate()+1);
    }
    return dates;
  }

  async function fetchHighTemp(date){
    let dt  = Math.floor(date.getTime()/1000);
    let url = `https://api.openweathermap.org/data/3.0/onecall/timemachine`
            + `?lat=${lat}&lon=${lon}&dt=${dt}`
            + `&appid=${apiKey}&units=imperial`;
    let res = await fetch(url);
    let data= await res.json();
    // Hourly array usually lives in `data.hourly`
    let hours = data.hourly || data.data || [];
    let temps = hours.map(h => h.temp||0);
    return Math.max(...temps);
  }

  async function countHotDays(){
    const keyCount = "hotDayCount2025";
    const keyList  = "hotDayList2025";
    const keyDate  = "hotDayCacheDate";
    const todayStr= new Date().toISOString().split("T")[0];

    // Try load from cache
    let cachedCount = localStorage.getItem(keyCount);
    let cachedList  = localStorage.getItem(keyList);
    let cachedDate  = localStorage.getItem(keyDate);

    if(cachedCount && cachedList && cachedDate===todayStr){
      drawResults(
        Number(cachedCount),
        JSON.parse(cachedList),
        "Loaded from cache."
      );
      return;
    }

    // Otherwise, fetch everything
    let start = "2025-01-01";
    let dates = generateDateRange(start, new Date());
    let hotCount = 0, hotList = [];

    for(let i=0; i<dates.length; i++){
      let d = dates[i];
      document.getElementById("counter-status").innerText =
        `Checking ${d.toDateString()} (${i+1} of ${dates.length})â€¦`;

      try {
        let maxT = await fetchHighTemp(d);
        if(maxT >= 90){
          hotCount++;
          hotList.push({
            date: d.toISOString().split("T")[0],
            temp: maxT.toFixed(1)
          });
        }
      } catch(err){
        console.error("Error on", d, err);
      }
      // avoid rate-limit
      await new Promise(r=>setTimeout(r,1100));
    }

    // Cache
    localStorage.setItem(keyCount, hotCount);
    localStorage.setItem(keyList, JSON.stringify(hotList));
    localStorage.setItem(keyDate, todayStr);

    drawResults(hotCount, hotList, "Data fetched fresh.");
  }

  function drawResults(count, list, statusMsg){
    document.getElementById("counter-status").innerText = statusMsg;
    document.getElementById("counter-result").innerText =
      `Total hot days (â‰¥ 90Â°F): ${count}`;

    let tbody = document.getElementById("hot-days-body");
    tbody.innerHTML = "";  // clear old
    for(let item of list){
      let row = `<tr>
        <td>${item.date}</td>
        <td>${item.temp}</td>
      </tr>`;
      tbody.insertAdjacentHTML("beforeend", row);
    }
  }
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  </script>
</body>
</html>
